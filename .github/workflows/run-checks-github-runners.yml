name: Run checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Run at 4am PT each day.
  schedule:
  - cron: '0 11 * * *'

  # Allow manual trigger.
  workflow_dispatch:

jobs:

  build-docker-image:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and export
        uses: docker/build-push-action@v3
        with:
          context: .
          tags: lakeroad:latest
          outputs: type=docker,dest=/tmp/lakeroad-docker-image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: lakeroad-docker-image
          path: /tmp/lakeroad-docker-image.tar

  run-tests:
    runs-on: ubuntu-latest
    needs: build-docker-image
    steps:

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: lakeroad-docker-image
          path: /tmp

      - name: Load image
        run: |
          docker load --input /tmp/lakeroad-docker-image.tar
          docker image ls -a

      - name: Run tests
        run: docker run lakeroad:latest bash run-tests.sh

  check-format:
    runs-on: self-hosted
    needs: build-docker-image
    steps:

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: lakeroad-docker-image
          path: /tmp

      - name: Load image
        run: |
          docker load --input /tmp/lakeroad-docker-image.tar
          docker image ls -a

      - name: Racket format check
        run: |
          docker run lakeroad:latest \
            bash -c 'raco fmt -i racket/*.rkt && [ -z "$(git status --porcelain)" ]'

      - name: Rust format check
        run: docker run lakeroad:latest cargo fmt --manifest-path ./rust/Cargo.toml -- --check
